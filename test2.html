# CHANGE TO YOUR DRIVE!
DRIVE=/dev/vda
DRIVE_EFI_PART=/dev/vda1
DRIVE_SYSTEM_PART=/dev/vda2

sgdisk --zap-all $DRIVE
sleep 1
sgdisk --clear \
       --new=1:0:+550MiB --typecode=1:ef00 --change-name=1:EFI \
       --new=2:0:0       --typecode=2:8300 --change-name=2:cryptsystem \
         $DRIVE

sleep 1
mkfs.fat -F32 -n EFI /dev/disk/by-partlabel/EFI
sleep 1
# Create luks container (luks1 for compatibility with grub)
cryptsetup --type luks1 --cipher aes-xts-plain64 --hash sha512 --use-random --verify-passphrase luksFormat /dev/disk/by-partlabel/cryptsystem
sleep 1
cryptsetup open /dev/disk/by-partlabel/cryptsystem system
sleep 1
mkfs.btrfs --force --label system /dev/mapper/system
sleep 1
o=defaults,x-mount.mkdir
sleep 1
o_btrfs=$o,compress=lzo,ssd,noatime
sleep 1
mount -t btrfs LABEL=system /mnt
sleep 1
btrfs subvolume create /mnt/root
sleep 1
btrfs subvolume create /mnt/home
sleep 1
btrfs subvolume create /mnt/snapshots
sleep 1
umount -R /mnt
sleep 1
mount -t btrfs -o subvol=root,$o_btrfs LABEL=system /mnt
sleep 1
mount -t btrfs -o subvol=home,$o_btrfs LABEL=system /mnt/home
sleep 1
mount -t btrfs -o subvol=snapshots,$o_btrfs LABEL=system /mnt/.snapshots
sleep 1
mkdir /mnt/boot
sleep 1
mount LABEL=EFI /mnt/boot
pacstrap /mnt base
sleep 1
genfstab -L -p /mnt >> /mnt/etc/fstab
sleep 1
vim /mnt/etc/fstab
sleep 1
wget tomasrejhons.github.io/malis/post-install
sleep 1
cp malis/post-install /mnt
sleep 1
arch-chroot /mnt
