#!/bin/bash

source config

function prepareInstall 
{
  timedatectl set-ntp true
  sleep 1

  # Optiomization of mirror list for best performance
  pacman -Syyy
  sleep 1
  pacman -S reflector
  sleep 1
  reflector -c $MIRRORS_LOCATION -a 10 --sort rate --save /etc/pacman.d/mirrorlist
  sleep 1
  pacman -Syyy
  sleep 1
}

function createPartitions
{
  sgdisk --zap-all $DRIVE
  sleep 1
  sgdisk --clear \
         --new=1:0:+600MiB --typecode=1:ef00 --change-name=1:EFI \
         --new=2:0:+500MiB --typecode=2:8300 --change-name=2:BOOT \
         --new=3:0:0       --typecode=3:8300 --change-name=3:SYSTEM \
           $DRIVE
           
  sleep 1
}

function setupEncryption
{
  modprobe dm-crypt
  sleep 1
  modprobe dm-mod
  sleep 1
  cryptsetup luksFormat -v -s 512 -h sha512 /dev/disk/by-partlabel/SYSTEM
  sleep 1
  cryptsetup open /dev/disk/by-partlabel/SYSTEM archsystem
  sleep 1
}

function setupFilesystemExt4
{
  # Init Filesystem
  mkfs.fat -F32 /dev/disk/by-partlabel/EFI
  sleep 1
  mkfs.ext4 /dev/disk/by-partlabel/BOOT
  sleep 1
  if ENCRYPT_SYSTEM; then
    mkfs.ext4 /dev/mapper/archsystem
    sleep 1
    mount /dev/mapper/archsystem /mnt
    sleep 1
  else
    mkfs.ext4 /dev/disk/by-partlabel/SYSTEM
    sleep 1
    mount /dev/disk/by-partlabel/SYSTEM /mnt
    sleep 1
  fi
  sleep 1

  # Mount Filesystem
  mkdir /mnt/boot
  sleep 1
  mount /dev/disk/by-partlabel/BOOT /mnt/boot
  sleep 1
  mkdir /mnt/boot/EFI
  sleep 1
  mount /dev/disk/by-partlabel/EFI /mnt/boot/EFI
  sleep 1
}

function installSystem
{
  pacstrap /mnt base base-devel linux linux-firmware vim
  sleep 1
  genfstab -L /mnt >> /mnt/etc/fstab
  sleep 1
  vim /mnt/etc/fstab
  sleep 1
  wget tomasrejhons.github.io/malis/ext4-luks-post
  sleep 1
  cp ext4-luks-post /mnt/post-install
  sleep 1
  cp config /mnt/malis-config
  sleep 1
  arch-chroot /mnt
}

prepareInstall
createPartitions
if ENCRYPT_SYSTEM; then
  setupEncryption
fi
setupFilesystemExt4
installSystem
