#!/bin/bash

# CHANGE TO YOUR DRIVE!
DRIVE=/dev/vda
DRIVE_EFI_PART=/dev/vda1
DRIVE_SWAP_PART=/dev/vda2
DRIVE_SYSTEM_PART=/dev/vda3

echo "---------------------------------------------"
echo "OPTIMIZING MIRRORLIST"
echo "---------------------------------------------"

pacman -Syyy
sleep 1
pacman -S reflector
sleep1
reflector -c Czechia -a 6 --sort rate --save /etc/pacman.d/mirrorlist
sleep 1
pacman -Syyy
sleep 1

echo "---------------------------------------------"
echo "CREATING PARTITIONS"
echo "---------------------------------------------"

sgdisk --zap-all $DRIVE
sleep 1
cfdisk $DRIVE
sleep 1

echo "---------------------------------------------"
echo "INIT FILESYSTEM"
echo "---------------------------------------------"

mkfs.fat -F32 $DRIVE_EFI_PART
sleep 1
mkswap -L SWAP $DRIVE_SWAP_PART
sleep 1
swapon $DRIVE_SWAP_PART
sleep 1
mkfs.btrfs -L SYSTEM $DRIVE_SYSTEM_PART
sleep 1

echo "---------------------------------------------"
echo "MOUNT FILESYSTEM"
echo "---------------------------------------------"

mount $DRIVE_SYSTEM_PART /mnt
sleep 1
btrfs su cr /mnt/@
sleep 1
btrfs su cr /mnt/@home
sleep 1
btrfs su cr /mnt/@var
sleep 1
btrfs su cr /mnt/@snapshots
sleep 1
umount /mnt
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@ $DRIVE_SYSTEM_PART /mnt
sleep 1
mkdir -p /mnt/{boot,home,var,.snapshots}
sleep 1
mount $DRIVE_EFI_PART /mnt/boot
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@home $DRIVE_SYSTEM_PART /mnt/home
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@var $DRIVE_SYSTEM_PART /mnt/var
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@snapshots $DRIVE_SYSTEM_PART /mnt/.snapshots
sleep 1

echo "---------------------------------------------"
echo "INSTALL BASE SYSTEM"
echo "---------------------------------------------"

pacstrap /mnt base linux linux-firmware nano snapper
sleep 1

echo "---------------------------------------------"
echo "CONFIGURE SYSTEM"
echo "---------------------------------------------"

genfstab -U /mnt >> /mnt/etc/fstab
sleep 1
arch-chroot /mnt
sleep 1
ln -sf /usr/share/zoneinfo/Europe/Prague /etc/localtime
sleep 1
hwclock --systohc
sleep 1
nano /etc/locale.gen
sleep 1
locale-gen
sleep 1
echo "LANG=en_US.UTF-8" >> /etc/locale.conf
sleep 1
echo "archblue" >> /etc/hostname
sleep 1
echo "127.0.0.1 localhost" >> /etc/hosts
sleep 1
echo "::1 localhost" >> /etc/hosts
sleep 1
echo "127.0.1.1 archblue.localdomain  archblue" >> /etc/hosts
sleep 1
passwd
sleep 1

echo "---------------------------------------------"
echo "FINISH INSTALLATION"
echo "---------------------------------------------"

pacman -S grub grub-btrfs efibootmgr networkmanager network-manager-applet wireless_tools wpa_supplicant dialog os-prober mtools dosfstools base-devel linux-headers reflector
sleep 1
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=ARCH_GRUB
sleep 1
