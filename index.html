#!/bin/bash

MIRRORS_LOCATION=Germany

# CHANGE TO YOUR DRIVE!
DRIVE=/dev/vda
DRIVE_EFI_PART=/dev/vda1
DRIVE_SWAP_PART=/dev/vda2
DRIVE_SYSTEM_PART=/dev/vda3

echo "---------------------------------------------"
echo "OPTIMIZING MIRRORLIST"
echo "---------------------------------------------"

pacman -Syyy
pacman -S reflector
reflector -c $MIRRORS_LOCATION -a 10 --sort rate --save /etc/pacman.d/mirrorlist
pacman -Syyy

echo "---------------------------------------------"
echo "CREATING PARTITIONS"
echo "---------------------------------------------"

sgdisk --zap-all $DRIVE
cfdisk $DRIVE

echo "---------------------------------------------"
echo "INIT FILESYSTEM"
echo "---------------------------------------------"

mkfs.fat -F32 $DRIVE_EFI_PART
sleep 1
mkswap -L SWAP $DRIVE_SWAP_PART
sleep 1
swapon $DRIVE_SWAP_PART
sleep 1
mkfs.btrfs -L SYSTEM $DRIVE_SYSTEM_PART
sleep 1

echo "---------------------------------------------"
echo "MOUNT FILESYSTEM"
echo "---------------------------------------------"

mount $DRIVE_SYSTEM_PART /mnt
sleep 1
btrfs su cr /mnt/@
sleep 1
btrfs su cr /mnt/@home
sleep 1
btrfs su cr /mnt/@var
sleep 1
btrfs su cr /mnt/@snapshots
sleep 1
umount /mnt
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@ $DRIVE_SYSTEM_PART /mnt
sleep 1
mkdir -p /mnt/{boot,home,var,.snapshots}
sleep 1
mount $DRIVE_EFI_PART /mnt/boot
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@home $DRIVE_SYSTEM_PART /mnt/home
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@var $DRIVE_SYSTEM_PART /mnt/var
sleep 1
mount -o noatime,compress=lzo,space_cache,subvol=@snapshots $DRIVE_SYSTEM_PART /mnt/.snapshots
sleep 1

echo "---------------------------------------------"
echo "INSTALL BASE SYSTEM"
echo "---------------------------------------------"

pacstrap /mnt base \
              linux \
              linux-firmware \
              nano \
              snapper \
              wget \
              

echo "---------------------------------------------"
echo "FINISH INSTALLATION"
echo "---------------------------------------------"

genfstab -U /mnt >> /mnt/etc/fstab
wget tomasrejhons.github.io/malis-post-install
cp malis-post-install /mnt
arch-chroot /mnt
