#!/bin/bash

MIRRORS_LOCATION=Germany

# CHANGE TO YOUR DRIVE!
DRIVE=/dev/vda

timedatectl set-ntp true
sleep 1

echo "---------------------------------------------"
echo "OPTIMIZING MIRRORLIST"
echo "---------------------------------------------"

pacman -Syyy
sleep 1
pacman -S reflector
sleep 1
reflector -c $MIRRORS_LOCATION -a 10 --sort rate --save /etc/pacman.d/mirrorlist
sleep 1
pacman -Syyy
sleep 1

echo "---------------------------------------------"
echo "PARTITION"
echo "---------------------------------------------"

sgdisk --zap-all $DRIVE
sleep 1
sgdisk --clear \
       --new=1:0:+550MiB --typecode=1:ef00 --change-name=1:EFI \
       --new=2:0:+10GiB  --typecode=2:8300 --change-name=2:BOOT \
       --new=3:0:0       --typecode=3:8300 --change-name=3:cryptsystem \
         $DRIVE
      
echo "---------------------------------------------"
echo "SETUP ENCRYPTION"
echo "---------------------------------------------"

sleep 1
modprobe dm-crypt
sleep 1
modprobe dm-mod
sleep 1
crypsetup luksFormat -v -s 512 -h sha512 /dev/disk/by-partlabel/cryptsystem
sleep 1
cryptsetup open /dev/disk/by-partlabel/cryptsystem archsystem
sleep 1

echo "---------------------------------------------"
echo "INIT FILESYSTEM"
echo "---------------------------------------------"

mkfs.fat -F32 /dev/disk/by-partlabel/EFI
sleep 1
mkfs.ext4 /dev/disk/by-partlabel/BOOT
sleep 1
mkfs.ext4 /dev/mapper/archsystem
sleep 1

echo "---------------------------------------------"
echo "MOUNT FILESYSTEM"
echo "---------------------------------------------"

mount /dev/mapper/archsystem /mnt
sleep 1
mkdir /mnt/boot
sleep 1
mount /dev/disk/by-partlabel/BOOT /mnt/boot
sleep 1
mkdir /mnt/boot/efi
sleep 1
mount /dev/disk/by-partlabel/EFI /mnt/boot/EFI
sleep 1

echo "---------------------------------------------"
echo "INSTALL BASE SYSTEM"
echo "---------------------------------------------"

pacstrap /mnt base base-devel linux linux-firmware vim
sleep 1
genfstab -L /mnt >> /mnt/etc/fstab
sleep 1
vim /mnt/etc/fstab
sleep 1
arch-chroot /mnt
