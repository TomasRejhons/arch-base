
DRIVE=/dev/DRIVEID

sgdisk --zap-all $DRIVE
sleep 1
sgdisk --clear \
       --new=1:0:+550MiB --typecode=1:ef00 --change-name=1:EFI \
       --new=2:0:+8GiB   --typecode=2:8200 --change-name=2:cryptswap \
       --new=3:0:0       --typecode=3:8300 --change-name=3:cryptsystem \
         $DRIVE

sleep 1
mkfs.fat -F32 -n EFI /dev/disk/by-partlabel/EFI
sleep 1
cryptsetup luksFormat --align-payload=8192 -s 256 -c aes-xts-plain64 /dev/disk/by-partlabel/cryptsystem
sleep 1
cryptsetup open /dev/disk/by-partlabel/cryptsystem system
sleep 1
cryptsetup open --type plain --key-file /dev/urandom /dev/disk/by-partlabel/cryptswap swap
sleep 1
mkswap -L swap /dev/mapper/swap
sleep 1
swapon -L swap
sleep 1
mkfs.btrfs --force --label system /dev/mapper/system
sleep 1
o=defaults,x-mount.mkdir
sleep 1
o_btrfs=$o,compress=lzo,ssd,noatime
sleep 1
mount -t btrfs LABEL=system /mnt
sleep 1
btrfs subvolume create /mnt/root
sleep 1
btrfs subvolume create /mnt/home
sleep 1
btrfs subvolume create /mnt/snapshots
sleep 1
umount -R /mnt
sleep 1
mount -t btrfs -o subvol=root,$o_btrfs LABEL=system /mnt
sleep 1
mount -t btrfs -o subvol=home,$o_btrfs LABEL=system /mnt/home
sleep 1
mount -t btrfs -o subvol=snapshots,$o_btrfs LABEL=system /mnt/.snapshots
sleep 1
pacstrap /mnt base
sleep 1
genfstab -L -p /mnt >> /mnt/etc/fstab
sleep 1
sed -i "s+LABEL=swap+/dev/mapper/swap" /mnt/etc/fstab
sleep 1
systemd-nspawn -bD /mnt
sleep 1
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
sleep 1
locale-gen
sleep 1
localectl set-locale LANG=en_US.UTF-8
sleep 1
timedatectl set-ntp 1
sleep 1
timedatectl set-timezone Europe/Prague
sleep 1
hostnamectl set-hostname archtest
sleep 1
echo "127.0.1.1	archtest.localdomain	archtest" >> /etc/hosts
sleep 1
pacman -Syu base-devel btrfs-progs iw gptfdisk zsh nvim terminus-font
